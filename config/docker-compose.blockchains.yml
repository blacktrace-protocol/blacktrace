version: '3.8'

# Blockchain Devnet Nodes for BlackTrace
#
# This file contains the blockchain node configurations for local development/testing.
# These are OPTIONAL - only needed when testing actual HTLC settlement.
#
# Usage:
#   # Run core services only (encrypted negotiation demo)
#   docker-compose up
#
#   # Run with blockchain nodes (full HTLC settlement testing)
#   docker-compose -f docker-compose.yml -f docker-compose.blockchains.yml up
#
# Note: Blockchain nodes take time to sync and require significant resources.
# For demo purposes, the core services work without blockchain nodes.

services:
  # Zcash Regtest Node
  # Provides a local Zcash blockchain for HTLC testing
  zcash-regtest:
    image: electriccoinco/zcashd:v5.8.0
    container_name: blacktrace-zcash-regtest
    environment:
      - ZCASH_NETWORK=regtest
    ports:
      - "18232:18232"  # RPC port
      - "18233:18233"  # P2P port (regtest)
    networks:
      - blacktrace-net
    volumes:
      - zcash-regtest-data:/root/.zcash
      - ./zcash-regtest.conf:/root/.zcash/zcash.conf:ro
    command: >
      -regtest
      -rpcuser=blacktrace
      -rpcpassword=regtest123
      -rpcallowip=0.0.0.0/0
      -rpcbind=0.0.0.0
      -server=1
      -txindex=1
      -experimentalfeatures
      -orchardwallet
      -allowdeprecated=getnewaddress
      -allowdeprecated=z_getnewaddress
      -allowdeprecated=z_getbalance
      -allowdeprecated=z_gettotalbalance
      -allowdeprecated=z_listaddresses
    healthcheck:
      test: ["CMD", "zcash-cli", "-regtest", "-rpcuser=blacktrace", "-rpcpassword=regtest123", "getblockchaininfo"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    restart: unless-stopped

  # Starknet Devnet Node (starknet-devnet-rs)
  # Provides a local Starknet blockchain for HTLC testing
  starknet-devnet:
    image: shardlabs/starknet-devnet-rs:0.1.2
    container_name: blacktrace-starknet-devnet
    ports:
      - "5050:5050"   # RPC port
    networks:
      - blacktrace-net
    command: ["--seed", "0", "--accounts", "10", "--initial-balance", "1000000000000000000000"]
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5050/is_alive"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    restart: unless-stopped

  # Solana Local Validator (solana-test-validator)
  # Provides a local Solana blockchain for HTLC testing
  # Uses SHA256 hashes compatible with Zcash for true atomic swaps
  solana-devnet:
    image: solanalabs/solana:v1.18.26
    container_name: blacktrace-solana-devnet
    ports:
      - "8899:8899"   # JSON-RPC port
      - "8900:8900"   # WebSocket port
      - "9900:9900"   # Faucet port
    networks:
      - blacktrace-net
    command: >
      solana-test-validator
      --bind-address 0.0.0.0
      --rpc-port 8899
      --faucet-port 9900
      --ledger /var/solana/ledger
      --limit-ledger-size 50000000
      --ticks-per-slot 8
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8899/health"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    restart: unless-stopped
    volumes:
      - solana-ledger-data:/var/solana/ledger

  # Starknet Sepolia RPC Proxy (for connecting to testnet instead of devnet)
  # Uncomment this service if you want to use Starknet Sepolia testnet
  # starknet-sepolia-proxy:
  #   image: nginx:alpine
  #   container_name: blacktrace-starknet-sepolia
  #   ports:
  #     - "5051:80"
  #   networks:
  #     - blacktrace-net
  #   volumes:
  #     - ./starknet-sepolia-proxy.conf:/etc/nginx/conf.d/default.conf:ro
  #   restart: unless-stopped

networks:
  blacktrace-net:
    external: true
    name: config_blacktrace-net

volumes:
  zcash-regtest-data:
  solana-ledger-data:
