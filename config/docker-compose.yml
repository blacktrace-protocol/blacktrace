version: '3.8'

# BlackTrace Core Services
#
# This file contains the core BlackTrace services for encrypted P2P negotiation.
# Blockchain nodes are SEPARATE - see docker-compose.blockchains.yml
#
# Usage:
#   # Core services only (encrypted negotiation demo - no HTLC settlement)
#   docker-compose up
#
#   # Full stack with blockchain nodes (for HTLC settlement testing)
#   docker-compose -f docker-compose.yml -f docker-compose.blockchains.yml up

services:
  # NATS message queue for settlement coordination
  nats:
    image: nats:2.10-alpine
    container_name: blacktrace-nats
    ports:
      - "4222:4222"
      - "8222:8222"
    networks:
      - blacktrace-net
    command: ["-js", "-m", "8222"]
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8222/healthz"]
      interval: 3s
      timeout: 2s
      retries: 5
      start_period: 5s

  # Bootstrap node (Maker)
  node-maker:
    build:
      context: ..
      dockerfile: services/node/Dockerfile
    container_name: blacktrace-maker
    environment:
      - NODE_TYPE=bootstrap
      - P2P_PORT=19000
      - API_PORT=8080
      - NODE_NAME=maker
      - NATS_URL=nats://nats:4222
    ports:
      - "8080:8080"
      - "19000:19000"
    networks:
      - blacktrace-net
    volumes:
      - maker-data:/root/.blacktrace
      - shared-identities:/root/.blacktrace/identities
    depends_on:
      nats:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # Taker node - connects to bootstrap node
  node-taker:
    build:
      context: ..
      dockerfile: services/node/Dockerfile
    container_name: blacktrace-taker
    environment:
      - NODE_TYPE=regular
      - P2P_PORT=19001
      - API_PORT=8081
      - NODE_NAME=taker
      - BOOTSTRAP_PEER=/ip4/node-maker/tcp/19000
      - NATS_URL=nats://nats:4222
    ports:
      - "8081:8081"
      - "19001:19001"
    networks:
      - blacktrace-net
    volumes:
      - taker-data:/root/.blacktrace
      - shared-identities:/root/.blacktrace/identities
    depends_on:
      nats:
        condition: service_healthy
      node-maker:
        condition: service_healthy
    command: ["node", "--port", "19001", "--api-port", "8081"]
    restart: unless-stopped

  # Settlement service - Coordinates atomic swaps
  # NOTE: For actual HTLC settlement, run with blockchain nodes:
  #   docker-compose -f docker-compose.yml -f docker-compose.blockchains.yml up
  # Without blockchain nodes, settlement requests are logged but not executed.
  settlement-service:
    build:
      context: ..
      dockerfile: services/settlement/Dockerfile
    container_name: blacktrace-settlement
    ports:
      - "8090:8090"
    environment:
      - NATS_URL=nats://nats:4222
      # Zcash Regtest configuration (from docker-compose.blockchains.yml)
      - ZCASH_RPC_URL=${ZCASH_RPC_URL:-http://zcash-regtest:18232}
      - ZCASH_RPC_USER=${ZCASH_RPC_USER:-blacktrace}
      - ZCASH_RPC_PASSWORD=${ZCASH_RPC_PASSWORD:-regtest123}
      - ZCASH_NETWORK=${ZCASH_NETWORK:-regtest}
      # Starknet Devnet configuration (from docker-compose.blockchains.yml)
      - STARKNET_RPC_URL=${STARKNET_RPC_URL:-http://starknet-devnet:5050}
      - STARKNET_NETWORK=${STARKNET_NETWORK:-devnet}
    networks:
      - blacktrace-net
    depends_on:
      nats:
        condition: service_healthy
    restart: unless-stopped

networks:
  blacktrace-net:
    driver: bridge

volumes:
  maker-data:
  taker-data:
  shared-identities:
