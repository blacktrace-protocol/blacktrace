version: '3.8'

services:
  # NATS message queue for settlement coordination
  nats:
    image: nats:2.10-alpine
    container_name: blacktrace-nats
    ports:
      - "4222:4222"
      - "8222:8222"
    networks:
      - blacktrace-net
    command: ["-js", "-m", "8222"]
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8222/healthz"]
      interval: 3s
      timeout: 2s
      retries: 5
      start_period: 5s

  # Bootstrap node (Maker - Alice)
  node-maker:
    build:
      context: ..
      dockerfile: services/node/Dockerfile
    container_name: blacktrace-maker
    environment:
      - NODE_TYPE=bootstrap
      - P2P_PORT=19000
      - API_PORT=8080
      - NODE_NAME=alice
      - NATS_URL=nats://nats:4222
    ports:
      - "8080:8080"
      - "19000:19000"
    networks:
      - blacktrace-net
    volumes:
      - maker-data:/root/.blacktrace
      - shared-identities:/root/.blacktrace/identities
    depends_on:
      nats:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s

  # Taker node (Bob) - starts after maker
  node-taker:
    build:
      context: ..
      dockerfile: services/node/Dockerfile
    container_name: blacktrace-taker
    environment:
      - NODE_TYPE=regular
      - P2P_PORT=19001
      - API_PORT=8081
      - NODE_NAME=bob
      - BOOTSTRAP_PEER=/ip4/node-maker/tcp/19000
      - NATS_URL=nats://nats:4222
    ports:
      - "8081:8081"
      - "19001:19001"
    networks:
      - blacktrace-net
    volumes:
      - taker-data:/root/.blacktrace
      - shared-identities:/root/.blacktrace/identities
    depends_on:
      nats:
        condition: service_healthy
      node-maker:
        condition: service_healthy
    command: ["node", "--port", "19001", "--api-port", "8081"]

  # Automated test runner
  test-runner:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: blacktrace-tests
    environment:
      - MAKER_API=http://node-maker:8080
      - TAKER_API=http://node-taker:8081
    networks:
      - blacktrace-net
    depends_on:
      node-maker:
        condition: service_healthy
      node-taker:
        condition: service_started
    # Wait for both nodes to be ready, then run tests
    command: /bin/sh -c "sleep 15 && /tests/run-e2e-tests.sh"
    profiles:
      - test

  # Zcash regtest node for development/demo
  zcash-regtest:
    image: electriccoinco/zcashd:v5.10.0
    container_name: zcash-regtest
    environment:
      - ZCASHD_EXTRA_ARGS=-mocktime
    ports:
      - "18232:18232"
    networks:
      - blacktrace-net
    volumes:
      - zcash-regtest-data:/srv/zcashd/.zcash
      - ./zcash.conf:/srv/zcashd/.zcash/zcash.conf
    cap_add:
      - SYS_NICE
      - SYS_RESOURCE
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "zcash-cli", "-regtest", "getblockchaininfo"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 20s

  # Go settlement service - Coordinates atomic swaps
  settlement-service:
    build:
      context: ..
      dockerfile: services/settlement/Dockerfile
    container_name: blacktrace-settlement
    ports:
      - "8090:8090"
    environment:
      - NATS_URL=nats://nats:4222
      - ZCASH_RPC_URL=http://zcash-regtest:18232
      - ZCASH_RPC_USER=blacktrace
      - ZCASH_RPC_PASSWORD=regtest123
      - ZCASH_NETWORK=regtest
    networks:
      - blacktrace-net
    depends_on:
      nats:
        condition: service_healthy
      zcash-regtest:
        condition: service_healthy
    restart: unless-stopped

  # React frontend - Split-screen UI for Alice and Bob
  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    container_name: blacktrace-frontend
    ports:
      - "5173:5173"
    networks:
      - blacktrace-net
    depends_on:
      - node-maker
      - node-taker
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5173/health"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s

  # Starknet devnet - Local Starknet testnet
  starknet-devnet:
    image: shardlabs/starknet-devnet-rs:latest
    container_name: blacktrace-starknet
    ports:
      - "5050:5050"
    networks:
      - blacktrace-net
    command: [
      "--seed", "0",
      "--accounts", "10",
      "--initial-balance", "1000000000000000000000"  # 1000 STRK per account
    ]
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5050/is_alive"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s

networks:
  blacktrace-net:
    driver: bridge

volumes:
  maker-data:
  taker-data:
  shared-identities:
  zcash-regtest-data:
